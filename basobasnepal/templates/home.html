{% load socialaccount %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BasoBas Nepal</title>
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    
    <!-- Add Google Font for a better look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Add jQuery for AJAX convenience -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <nav class="custom-navbar">
        <a class="navbar-logo" href="{% url 'home' %}">
            <img src="{% static 'images/logo.jpg' %}" alt="BasoBas Logo" class="navbar-logo-img">
            <span>BasoBas Nepal</span>
        </a>
        <div class="navbar-right">
            {% if user.is_authenticated %}
                <a href="{% url 'profile' %}" class="profile-button">
                    {# IMPROVED: Safer way to get avatar, with a fallback #}
                    {% with avatar_url=user.socialaccount_set.first.get_avatar_url %}
                        <img src="{% firstof avatar_url 'https://i.stack.imgur.com/34AD2.jpg' %}" alt="Profile" class="profile-button-img">
                    {% endwith %}
                    <span>{{ user.first_name }}</span>
                </a>
                <a href="{% url 'landlord' %}" class="navbar-action-link">Be a landlord</a>
            {% else %}
                <a href="{% url 'custom_login' %}" class="navbar-action-link">Log in</a>
                <a href="{% url 'custom_login' %}?next={% url 'landlord' %}" class="navbar-action-link">Be a landlord</a>
            {% endif %}
        </div>
    </nav>

    <header class="page-header">
        <h1>Find your room or flat</h1>
        <p>Browse available listings across Nepal</p>
    </header>

    <!-- FILTER DROPDOWN -->
    <div class="filter-container">
        <label for="districtFilter">Filter by District:</label>
        <select id="districtFilter" name="district">
            <option value="">-- All Districts --</option>
            {% for district in districts %}
                <option value="{{ district }}">{{ district }}</option>

            {% endfor %}
        </select>
    </div>

    <main class="container">
        <!-- The content of this div will be replaced by AJAX -->
        <div class="rooms-grid" id="roomsContainer">
            {% for room in rooms %}
                <div class="card">
                    <a href="{% url 'description' room.pk %}" class="stretched-link">
                        <span class="visually-hidden">View details for room in {{room.municipality}}</span>
                    </a>
                    
                    {% if room.photos.name %}
                        <img src="{{ room.photos.url }}" alt="Photo of room in {{room.municipality}}" class="card-img">
                    {% else %}
                        <div class="card-no-img">No Photo Available</div>
                    {% endif %}

                    <div class="card-content">
                        <p><strong>Location:</strong> {{room.municipality}} {{room.ward_num}}, {{room.district}}</p>
                        <p><strong>Rooms:</strong> {{room.num_of_rooms_available}}</p>
                    </div>
                    
                    {% if request.user == room.owner %}
                    <div class="card-footer">
                        <a href="{% url 'edit' room.pk %}" class="butt btn-edit">Edit</a>
                        <a href="{% url 'delete' room.pk %}" class="butt btn-delete">Delete</a>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </main>

<script>
    // Pass Django URLs to JavaScript safely
    const URL_CONFIG = {
        description: "/basobasnepal/description",
        edit: "/basobasnepal/edit",
        delete: "/basobasnepal/delete"
    };

    $(document).ready(function(){
        $('#districtFilter').change(function(){
            const selectedDistrict = $(this).val();
            const roomsContainer = $('#roomsContainer');

            $.ajax({
                url: "{% url 'filter_rooms' %}",
                data: {
                    'district': selectedDistrict
                },
                dataType: 'json',
                // ADDED: Show a loading state to the user
                beforeSend: function() {
                    roomsContainer.html(`
                        <div class="ajax-message">
                            <div class="loader"></div>
                            <p>Loading rooms...</p>
                        </div>
                    `);
                },
                success: function(data) {
                    let roomsHtml = '';
                    if(data.rooms.length === 0) {
                        roomsHtml = '<div class="ajax-message"><p>No rooms found in this district.</p></div>';
                    } else {
                        data.rooms.forEach(function(room){
                            roomsHtml += `
                                <div class="card">
                                    <a href="${URL_CONFIG.description}/${room.pk}/" class="stretched-link">
                                        <span class="visually-hidden">View details for room in ${room.municipality}</span>
                                    </a>
                                    
                                    ${room.photo_url ? `<img src="${room.photo_url}" alt="Photo of room in ${room.municipality}" class="card-img">` : '<div class="card-no-img">No Photo Available</div>'}

                                    <div class="card-content">
                                        <p><strong>Location:</strong> ${room.municipality} ${room.ward_num}, ${room.district}</p>
                                        <p><strong>Rooms:</strong> ${room.num_of_rooms_available}</p>
                                    </div>
                                    
                                    ${room.is_owner ? `
                                    <div class="card-footer">
                                        <a href="${URL_CONFIG.edit}/${room.pk}/" class="butt btn-edit">Edit</a>
                                        <a href="${URL_CONFIG.delete}/${room.pk}/" class="butt btn-delete">Delete</a>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                    }
                    roomsContainer.html(roomsHtml);
                },
                // ADDED: Handle potential server errors
                error: function() {
                    roomsContainer.html('<div class="ajax-message"><p>Sorry, an error occurred. Please try again later.</p></div>');
                }
            });
        });
    });
</script>

</body>
</html>